  - key: cleanup
    label: ":broom: Cleanup wayward stacks"
    <<: *default-agents
    command: |
      source ./lib/lib.bash

      git::repos::add git@github.com:abklabs/solana-lab.git solana-lab
      git::repos::add git@github.com:abklabs/tooling.git tooling
      git::repos::summary
      git::repos::clone

      if (cd solana-lab && pulumi stack select "$$PULUMI_STACK_NAME" 2>/dev/null) ; then
        bk::group ":white_check_mark: Stack '$$PULUMI_STACK_NAME' does not exist. Nothing to destroy."
        exit 0
      fi

      setup-aws-credentials
      setup-gcp-credentials

      PATH=$$(realpath ./tooling/bin):$$PATH
      (
        cd solana-lab
        pulumi-install-and-run cleanup-pulumi-stack "$$PULUMI_STACK_NAME"
      )

    depends_on: ["solana-lab"]
    allow_dependency_failure: true
