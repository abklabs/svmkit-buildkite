  - key: solana-lab
    label: ":test_tube: solana-lab"
    <<: *default-agents
    concurrency: 1
    concurrency_group: sequential-steps
    command: |
      source ./lib/lib.bash

      git::repos::add git@github.com:abklabs/solana-lab.git solana-lab
      git::repos::add git@github.com:abklabs/tooling.git tooling
      git::repos::summary
      git::repos::clone

      setup-aws-credentials
      setup-gcp-credentials

      PATH=$$(realpath ./tooling/bin):$$PATH
      (
        cd solana-lab
        bk::group "Searching for pipeline build package overrides"
        if buildkite-agent artifact search 'build/*.deb' ; then
          bk::group "Getting Artifacts"
          buildkite-agent artifact download build/*.deb . --build "${PARENT_BUILD_ID:-$BUILDKITE_BUILD_ID}"
        else
          bk::group "No Artifacts Found"
        fi
        bk::group "Setting up for Test Suite"
        pulumi stack init "$$PULUMI_STACK_NAME"
        pulumi stack select "$$PULUMI_STACK_NAME"

        if [[ -d build ]] ; then
          log::info "Configuring local stack to use 'build' as a package override directory"
          pulumi config set packageConfig:overrideDir build
        fi

        if ! $$DRY_RUN ; then
          pulumi-install-and-run with-pulumi-up with-rpc-forwarded prove --ext .ts --ext .t test
        else
          log::info "Skipping bringing up pulumi"
        fi
        pulumi stack rm --yes
      )
